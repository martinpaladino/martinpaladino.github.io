---
title: "Análisis de Correspondencias Múltiples"
author: "Martín Paladino"
date: "27 de abril de 2017"
output: 
  ioslides_presentation: 
    widescreen: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r, librerias}
library(tidyverse)
library(DiagrammeR)
library(FactoMineR)
library(factoextra)
library(pander)

#Arregla nombres de la base. 
arreglar_nombres <- function(.) {rename(.,PrefMuscRock=PrefMusRock, PrefMuscMetal=PrefMusMetal, PrefMuscPop=PrefMusiPop, PrefMuscElectr=PrefMusiElectr)}

#Nombres cortos. Pasar después de select()
nombrar_corto <- function (.) {rename(., Rock=PrefMuscRock,  Metal=PrefMuscMetal, Pop=PrefMuscPop,   `Electronica`=PrefMuscElectr, Tradicional=PrefMuscTradic, Cumbia=PrefMuscCumb,Salsa  =PrefMuscSalsa, Regaetton =PrefMuscRegu, Trova =PrefMuscTrova, `Culta`=PrefMuscCulta, `Romantica`=PrefMuscRoman)}
```

# ACM/MCA

##Objetivos de la sesión

- Introducir de manera práctica el concepto de **variable latente**. 
- Identificar el problema que resuelve el ACM. 
- Implementar el Análisis de Correspondencias Múltiples con la función `FactoMineR::MCA()` en R.

## Variables latentes

- Hasta ahora en el curso hemos trabajado con un tipo de variables: las variables observadas. 
    - Registran atributos directamente medibles de un objeto estadístico. 
    - Ejp. respuestas a un ítem de un cuestionario.
- Sin embargo, algunos conceptos centrales de las ciencias sociales no son directamente medibles. 
    - El desarrollo, el gusto, la inteligencia (¿?).
- Podemos **inferirlos** a partir de un set de variables observadas. 
    - O considerarlos la causa del comportamiento de las variables observadas. 

# Tres abordajes para el análisis de variables latentes 

    
## Abordaje inferencial (SEM)

```{r, fig.height=8, fig.width=10}
grViz("digraph boxes_and_circles {
  graph [overlap = true, fontsize = 10]
node [shape = box, fontname = Helvetica]
  
  B[label='Rock']
  C[label='Metal']
  D[label='Trova']
  E[label='Romántica']
  F[label='Tradicional']
  G[label='Culta']
  H[label='Reggaeton']
  I[label='Salsa']
  J[label='Cumbia']
  K[label='Electrónica']
  L[label='Pop']

node [shape=circle]
  A[label='Gusto']

{B, C, D, E, F, G, H, I, J, K L} -> A
}")
```

## Abordaje causal (SEM)

```{r, fig.height=8, fig.width=10}
grViz("digraph boxes_and_circles {
  graph [overlap = true, fontsize = 10]
node [shape = box, fontname = Helvetica]
  
  B[label='Rock']
  C[label='Metal']
  D[label='Trova']
  E[label='Romántica']
  F[label='Tradicional']
  G[label='Culta']
  H[label='Reggaeton']
  I[label='Salsa']
  J[label='Cumbia']
  K[label='Electrónica']
  L[label='Pop']

node [shape=circle]
  A[label='Gusto']

A->{B, C, D, E, F, G, H, I, J, K L}
}")
```

## Abordaje de reducción de la dimensionalidad (ACM)

```{r, MCA_gusto, fig.height=5, fig.width=8}
load("C:/Users/mpaladino/Dropbox/Ibero/BaseConjunta.Rda")
df %>% 
  arreglar_nombres() %>% 
  dplyr::select(contains("PrefMusc"), Ciudad) %>% 
  nombrar_corto() %>% 
  filter(Ciudad=="Mexico") %>% 
  select(-Ciudad) -> datos 
  MCA(datos, graph=FALSE) -> 
  res.MCA
fviz_mca_var(res.MCA, col.var = "black", geom="text") + labs(x="Inactivos - Activos", y="Culto - Popular", title="") + theme_minimal()
```

#El problema del Análisis de Correspondencias Múltiples

## Análisis de datos categóricos

- El primer abordaje es el análisis de tablas de contingencia. 
    - Incluyendo las pruebas de bondad del ajuste con respecto a un modelo de independencia.
    
```{r, tabla}
library(printr)
library(magrittr)
datos %$% table(Rock,Salsa) -> tabla
tabla
summary(tabla)
```

## Con más categorías el análisis se hace más complejo.

```{r, tabla2}
library(printr)
library(magrittr)
datos %$% table(Rock,Salsa, Pop) -> tabla2
tabla2
```

## ¿Por qué?

- El número de dimensiones de la tabla es aumenta con cada variable.
- El número de celdas cruzadas aumenta exponencialmente con el número de categorías. 
    - En este ejemplo con 11 variables dicotómicas es 2^11^: 2048 posibles combinaciones.^[Exponencial de todas las variables tienen el mismo número de modalidades.]  
    - Aunque no todas están observadas en un conjunto de datos empírico. 
    - En nuestro ejemplo hay 219 patrones de respuesta diferentes. 

Intentémoslo apoyados en un gráfico de mosaico, cortesía de Michael Friendly.

### Sintáxis

`vcd::mosaic(tabla, shade=T, main="Título")`

## Preferencias de géneros musicales

```{r, mosaico, fig.height=6, fig.width=10}
vcd::mosaic(tabla2, shade=T)
```

#Como hacer una nube con una tabla.
La alquimia del ACM 

## Reducción de la dimensionalidad. 

- El problema de las tablas de contingencia multidimensionales es exactamente el gran número de dimensiones. 
- El ACM atiende ese problema reduciendo la dimensionalidad.
    - Identifica coordenadas principales que dan cuenta, en orden decreciente, de la mayor variabilidad posible de los datos. 
- Matemáticamente es la descomposición de valores singulares de la matriz de residuos $\chi~2$.
    - Aunque hay varias formulaciones matemáticas del ACM.
    - Formulación geométrica. Como matriz de distancias. 
    - Formulación correlacional. Como un problema de correlación canónica. 
## El resultado es un sistema de coordenadas que "ordena" a las categorías y a los individuos por similitud/diferencia en varias dimensiones. 

## Dimensión 1. Activos e inactivos. 

```{r, ordenados}
rbind(head(arrange(datos, res.MCA$ind$coord[,1]), 5), tail(arrange(datos, res.MCA$ind$coord[,1]), 5))

## Dimensión 2. Bailables y escuchables (?). 

```{r}
rbind(head(arrange(datos, res.MCA$ind$coord[,2]), 5), tail(arrange(datos, res.MCA$ind$coord[,2]), 5))
```

## Condiciones. 

- A diferencias de los `lm` el ACM no tiene supuestos distribucionales, pero tiene algunas condiciones que debemos atender. 

- Un conjunto de variables categóricas
    - En R codificadas con el tipo `factor`
- Que, para un tema de interés, son: 
    - Homogéneas. 
        - Miden indirectamente un mismo atributo. 
        - Que deberíamos definir previamente de manera teórica.
    - Exhaustivas. 
        - Son suficientes para caracterizar el fenómeno o estructura de interés. 
- Preferentemente con una distribución balanceada: ninguna categoría tiene una *n* muy pequeña. 

## ACM en R con FactoMineR

- Hay varias funciones para realizar ACM en R. 
      - `CA::mjca`, `MASS::mca`, `homals::homals()`, `FactoMineR::MCA()`
- Utilizamos `FactoMineR::MCA()` porque en conjunción con `factoextra::` da las mejores salidas gráficas estandar. 
- `CA::mjca` implementa el Joint Multiple Correspondence Analysis.
    - Estima las mismas coordenadas, pero calcula con más precisión los valores propios (varianza explicada).
- `factoextra::` tiene funciones para graficar las cantidades de interés: nubes, varianzas explicada, contribución de las categorías. 
    - De todos modos podemos extraer la información de objeto MCA y generar los gráficos. 
- Ninguna de estas funciones usa sintaxis de fórmula. :-(

## Sintáxis de `MCA()`

`MCA(data.frame, ncp=5, quali.sup=c(12, 13, 14)), graph=FALSE`

- Donde: `data.frame` es la estructura de datos que contiene las variables. 
    - Deben ser del tipo factor.
- `ncp= ` es el número de dimensiones que conservamos. Por defecto 5. 
- `quali.sup` es un vector numérico con los números de índice de las columnas suplementarias, de las que hablare luego. 
- `graph=FALSE` para evitar que imprima el --inútil-- gráfico por defecto. 

## Resultados

`MCA()` produce una lista de la clase `MCA` con toda la información del análisis. 

Cantidad de interés | Uso
--------------------|------------------------------
$eigen              | Varianza explicada por cada dimensión
\$var$contrib       | Contribución de cada categoría a cada dimensión
\$ind$contrib       | Contribución de cada individuos a cada dimensión
\$var$coord         | Coordenadas de las categorías
\$ind$coord         | Coordenadas de los individuos

Table: Algunas cantidades de interés de un ACM

## ¿Cuántas dimensiones interpretar?

```{r}
fviz_eig(res.MCA)
```
## Nube de las categorías. 

```{r}
fviz_mca_var(res.MCA, axes=c(1,2)) + theme_minimal()
```

## Nube de las categorías II..

```{r}
fviz_mca_var(res.MCA, axes=c(2,3)) + theme_minimal()
```

##Contribución de las categorías.

```{r, fig.height=3}
fviz_contrib(res.MCA, choice="var", axes=c(1)) + theme_minimal()
fviz_contrib(res.MCA, choice="var", axes=c(2)) + theme_minimal()
```

## Categorías suplementarias. 

- Dado el criterio de **homogeneidad** no es apropiado incluir en el set de variables de interés. 
    - "Deformarían" el sistema de coordenadas.
- Para analizar la correspondencia entre las variables de interés y otras podemos incluirlas en el análisis como variables suplementarias. 
    - Se mapean en el sistema de coordenadas de las de interés, pero tienen contribución 0 en su definición. 
- Podemos pensarlas, por analogía al lenguaje de `lm`, como variables independientes.
    - Aunque el ACM es completamente *simétrico*. 

##  Variables sociodemográficas suplementarias. 

```{r , fig.height=6, fig.width=8}
df %>% 
  arreglar_nombres() %>% 
  dplyr::select(contains("PrefMusc"), Ciudad, Sexo, Rng_edad, NSE) %>% 
  nombrar_corto() %>% 
  filter(Ciudad=="Mexico") %>% 
  select(-Ciudad) %>% 
  MCA(., quali.sup=12:14, graph=F) -> res.MCA2
fviz_mca_var(res.MCA2, axes=c(2,3)) + theme_minimal()
```

## Variables suplementarias (zoom)

```{r, fig.height=6, fig.width=8}
fviz_mca_var(res.MCA2, axes=c(2,3), invisible="var") + theme_minimal()
```

## 

```{r, fig.height=6, fig.width=8}
library(ggExtra)
foo <- fviz_mca_var(res.MCA2, axes=c(2,3)) + theme_minimal() 
bar <- res.MCA2$ind$coord [, c(2,3)] %>% as.data.frame() 
ggMarginal(foo, bar, bar$`Dim 2`, bar$`Dim 3`)
```

